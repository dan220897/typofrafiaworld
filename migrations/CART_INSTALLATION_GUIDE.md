# Руководство по установке корзины и точек самовывоза

## Обзор изменений

В проект добавлен функционал корзины покупок и точек самовывоза:

1. **Улучшенный поиск**
   - На главной странице поиск теперь работает не только по категориям, но и по названиям услуг (подкатегорий)
   - При поиске по услуге отображается её родительская категория
   - Внутри категории поиск работает только по услугам (как и было)

2. **Корзина покупок**
   - Пользователи могут добавлять услуги в корзину
   - Корзина работает для авторизованных и неавторизованных пользователей
   - Всплывающий попап корзины с управлением товарами
   - Возможность изменения количества, удаления товаров

3. **Оформление заказа без авторизации**
   - Форма с полями: имя, телефон, email (необязательно)
   - Выбор точки самовывоза на интерактивной карте Яндекс
   - Список точек самовывоза с адресами и часами работы
   - Комментарий к заказу

## Установка

### Шаг 1: Применить миграцию БД

Примените миграцию `010_create_cart_and_pickup_points.sql` к базе данных:

```bash
# Через командную строку MySQL (если доступен)
mysql -u USERNAME -p DATABASE_NAME < migrations/010_create_cart_and_pickup_points.sql

# Или через phpMyAdmin:
# 1. Откройте phpMyAdmin
# 2. Выберите вашу базу данных
# 3. Перейдите на вкладку "SQL"
# 4. Скопируйте содержимое файла migrations/010_create_cart_and_pickup_points.sql
# 5. Вставьте в поле SQL запроса и нажмите "Выполнить"
```

Миграция создаст:
- Таблицу `cart` для хранения товаров в корзине
- Таблицу `pickup_points` для точек самовывоза
- 5 тестовых точек самовывоза в Москве

### Шаг 2: Настроить API ключ Яндекс.Карт

Получите бесплатный API ключ Яндекс.Карт:
1. Перейдите на https://developer.tech.yandex.ru/
2. Зарегистрируйтесь и создайте новое приложение
3. Получите JavaScript API ключ

Откройте файл `components/cart.php` и замените `YOUR_API_KEY` на ваш ключ:

```html
<!-- Строка 483 -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_API_KEY&lang=ru_RU"></script>
```

Замените `YOUR_API_KEY` на ваш реальный ключ, например:
```html
<script src="https://api-maps.yandex.ru/2.1/?apikey=a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6&lang=ru_RU"></script>
```

### Шаг 3: Проверить работу

1. Откройте главную страницу сайта
2. В header справа должна появиться иконка корзины
3. Перейдите на страницу любой услуги
4. Нажмите кнопку "Добавить в корзину"
5. Откроется попап корзины с добавленным товаром
6. Нажмите "Оформить заказ" для проверки формы

## Структура файлов

### Новые файлы:

- `migrations/010_create_cart_and_pickup_points.sql` - миграция БД
- `api/cart.php` - REST API для работы с корзиной
- `components/cart.php` - UI компонент корзины

### Измененные файлы:

- `index.php` - добавлен улучшенный поиск и компонент корзины
- `catalog.php` - добавлен компонент корзины
- `service.php` - кнопка "Оформить заказ" заменена на "Добавить в корзину"

## API Endpoints

### GET /api/cart.php
Получить содержимое корзины
```json
{
  "success": true,
  "data": {
    "items": [...],
    "total_amount": 1500,
    "total_items": 3
  }
}
```

### POST /api/cart.php?action=add
Добавить товар в корзину
```json
{
  "service_id": "print_bw_a4",
  "quantity": 10,
  "unit_price": 3.00,
  "parameters": {
    "size": "A4",
    "density": "80 г/м²",
    "sides": "Односторонняя",
    "quantity": "10 листов"
  }
}
```

### PUT /api/cart.php?action=update
Обновить количество товара
```json
{
  "cart_id": 1,
  "quantity": 20
}
```

### DELETE /api/cart.php?action=remove
Удалить товар из корзины
```json
{
  "cart_id": 1
}
```

### DELETE /api/cart.php?action=clear
Очистить всю корзину

### GET /api/cart.php?action=pickup_points
Получить список точек самовывоза
```json
{
  "success": true,
  "data": {
    "pickup_points": [
      {
        "id": 1,
        "name": "Типо-графия на Тверской",
        "address": "г. Москва, ул. Тверская, д. 10",
        "latitude": 55.764484,
        "longitude": 37.605713,
        "phone": "+7 (495) 123-45-67",
        "working_hours": "Пн-Пт: 9:00-20:00, Сб-Вс: 10:00-18:00"
      },
      ...
    ]
  }
}
```

### POST /api/cart.php?action=checkout
Оформить заказ
```json
{
  "name": "Иван Иванов",
  "phone": "+7 (999) 123-45-67",
  "email": "ivan@example.com",
  "pickup_point_id": 1,
  "notes": "Заказ срочный"
}
```

Ответ:
```json
{
  "success": true,
  "data": {
    "order_id": 123,
    "order_number": "ORD-20260111-5678",
    "message": "Order created successfully"
  }
}
```

## Использование

### Для пользователя:

1. **Добавление товара в корзину:**
   - Выберите услугу
   - Настройте параметры в калькуляторе
   - Нажмите "Добавить в корзину"

2. **Просмотр корзины:**
   - Кликните на иконку корзины в header
   - Откроется попап с содержимым корзины

3. **Управление товарами:**
   - Изменить количество кнопками +/-
   - Удалить товар кнопкой ✕

4. **Оформление заказа:**
   - Нажмите "Оформить заказ"
   - Заполните форму (имя, телефон)
   - Выберите точку самовывоза на карте или из списка
   - Нажмите "Оформить заказ"

### Для разработчика:

Добавить товар в корзину из JavaScript:
```javascript
await addToCart(
  'service_id',     // ID услуги
  10,               // Количество
  50.00,            // Цена за единицу
  {                 // Параметры (необязательно)
    size: 'A4',
    density: '80 г/м²'
  }
);
```

Открыть попап корзины:
```javascript
openCartPopup();
```

Закрыть попап корзины:
```javascript
closeCartPopup();
```

## Управление точками самовывоза

### Добавить новую точку через SQL:

```sql
INSERT INTO pickup_points (name, address, latitude, longitude, phone, working_hours, is_active, sort_order)
VALUES (
  'Название точки',
  'Полный адрес',
  55.751244,  -- Широта
  37.618423,  -- Долгота
  '+7 (XXX) XXX-XX-XX',
  'Пн-Пт: 9:00-18:00',
  1,  -- Активна
  10  -- Порядок сортировки
);
```

### Получить координаты адреса:

1. Откройте https://yandex.ru/maps
2. Найдите нужный адрес
3. Кликните правой кнопкой на карте
4. Выберите "Что здесь?"
5. Скопируйте координаты (широта, долгота)

### Деактивировать точку:

```sql
UPDATE pickup_points SET is_active = 0 WHERE id = 1;
```

## Безопасность

- Корзина для неавторизованных хранится по session_id
- Корзина для авторизованных привязана к user_id
- При оформлении заказа создается пользователь по телефону (если не авторизован)
- Все SQL запросы используют подготовленные выражения (prepared statements)
- Входные данные валидируются на сервере

## Дальнейшие улучшения

- [ ] Добавить уведомления (Telegram/Email) при оформлении заказа
- [ ] Реализовать промокоды для корзины
- [ ] Добавить расчет доставки
- [ ] Сохранять корзину при авторизации
- [ ] Добавить "Избранное"
- [ ] Email подтверждение заказа

## Поддержка

При возникновении проблем:
1. Проверьте логи PHP ошибок
2. Проверьте консоль браузера на JS ошибки
3. Убедитесь что миграция применена корректно
4. Проверьте что API ключ Яндекс.Карт корректен

## Лицензия

Проект использует открытые технологии:
- Яндекс.Карты (бесплатно до 25000 запросов/день)
- Font Awesome (бесплатная лицензия)
