# Настройка мультилокационной системы администрирования

## Обзор изменений

Система администрирования была обновлена для поддержки нескольких точек (филиалов) с раздельным доступом:

### Ключевые изменения:

1. **Два типа входа:**
   - **Администратор точки** - выбирает точку из списка и вводит пароль точки
   - **Суперадминистратор** - вход по логину и паролю с полным доступом

2. **Разделение прав:**
   - Администраторы точек видят только данные своей точки
   - Суперадминистратор видит агрегированные данные всех точек
   - Управление услугами, администраторами, настройками и логами - только у суперадмина
   - Чаты убраны из меню администраторов точек

3. **Новая структура БД:**
   - Таблица `locations` для хранения информации о точках
   - Поле `location_id` в таблицах `orders`, `admins`, `services`
   - Связь заказов с конкретными точками

## Инструкция по установке

### Шаг 1: Применить миграцию базы данных

Выполните SQL миграцию для создания необходимых таблиц и полей:

```bash
mysql -u username -p database_name < migrations/add_multi_location_support.sql
```

Или импортируйте файл через phpMyAdmin:
- Откройте phpMyAdmin
- Выберите вашу базу данных
- Перейдите на вкладку "Импорт"
- Выберите файл `migrations/add_multi_location_support.sql`
- Нажмите "Вперёд"

### Шаг 2: Проверка созданных таблиц и данных

После выполнения миграции проверьте, что:

1. Создана таблица `locations` с 3 тестовыми точками:
   - Центральный офис (код: `central`)
   - Филиал на Арбате (код: `arbat`)
   - Филиал в ТЦ Мега (код: `mega`)

2. В таблице `admins` добавлено поле `location_id`

3. В таблицах `orders` и `services` добавлено поле `location_id`

### Шаг 3: Настройка паролей для точек

**ВАЖНО!** По умолчанию все точки имеют пароль `password`. Измените пароли после первого входа!

Чтобы изменить пароль точки:
1. Войдите как суперадминистратор
2. Перейдите в раздел "Точки"
3. Отредактируйте нужную точку
4. Введите новый пароль (минимум 6 символов)

### Шаг 4: Создание суперадминистратора (если нет)

Если у вас ещё нет суперадминистратора, создайте его через SQL:

```sql
INSERT INTO admins (username, password_hash, full_name, email, role, is_active)
VALUES (
    'superadmin',
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- password
    'Супер Администратор',
    'admin@typografia.ru',
    'super_admin',
    1
);
```

> Пароль: `password` - обязательно измените после первого входа!

Или обновите существующего админа до super_admin:

```sql
UPDATE admins SET role = 'super_admin' WHERE username = 'your_username';
```

## Использование системы

### Вход для администратора точки

1. Откройте: `https://your-domain.com/admin/login-location.php`
2. Выберите вашу точку из выпадающего списка
3. Введите пароль точки
4. Нажмите "Войти"

После входа вы увидите:
- Дашборд с данными вашей точки
- Заказы только вашей точки
- Пользователей
- Отзывы и промокоды

**Недоступно для администратора точки:**
- Чаты
- Управление услугами
- Управление администраторами
- Настройки системы
- Логи

### Вход для суперадминистратора

1. Откройте: `https://your-domain.com/admin/login-superadmin.php`
2. Введите логин суперадмина
3. Введите пароль
4. Нажмите "Войти"

После входа вы получите полный доступ ко всем функциям:
- Агрегированные данные всех точек
- Управление точками (создание, редактирование, активация/деактивация)
- Управление услугами
- Управление администраторами
- Настройки системы
- Просмотр логов

## Управление точками (для суперадмина)

### Создание новой точки

1. Войдите как суперадминистратор
2. Перейдите в "Администрирование" → "Точки"
3. Нажмите "Добавить точку"
4. Заполните форму:
   - **Название точки** - отображаемое название
   - **Код точки** - уникальный идентификатор для входа (только латиница, цифры, дефис)
   - **Адрес** - физический адрес точки
   - **Телефон** - контактный телефон
   - **Email** - контактный email
   - **Пароль** - пароль для входа администратора точки (минимум 6 символов)
5. Нажмите "Сохранить"

### Редактирование точки

1. На странице "Точки" найдите нужную точку
2. Нажмите кнопку "Редактировать"
3. Измените необходимые данные
4. Для изменения пароля - введите новый пароль (или оставьте поле пустым для сохранения текущего)
5. Нажмите "Сохранить"

### Активация/деактивация точки

1. На странице "Точки" найдите нужную точку
2. Нажмите кнопку "Деактивировать" или "Активировать"
3. Подтвердите действие

**Примечание:** При деактивации точки администраторы не смогут войти в систему под этой точкой.

## Настройка заказов для конкретной точки

При создании или редактировании заказа необходимо указывать точку, к которой относится заказ:

```php
// Пример создания заказа
$order->location_id = 1; // ID точки
$order->user_id = $user_id;
$order->total_price = $total;
$order->create();
```

Для location admins поле `location_id` автоматически устанавливается из сессии.

## Структура файлов

### Новые файлы:

```
/admin/
├── login-location.php           # Страница входа для админов точек
├── login-superadmin.php          # Страница входа для суперадмина
├── login_process_location.php    # Обработка входа админов точек
├── login_process_superadmin.php  # Обработка входа суперадмина
├── locations.php                 # Управление точками (суперадмин)
├── classes/
│   └── Location.php             # Класс для работы с точками
├── api/
│   └── locations.php            # API для CRUD операций с точками
└── migrations/
    └── add_multi_location_support.sql  # Миграция БД
```

### Обновленные файлы:

- `admin/includes/auth_check.php` - добавлена поддержка location admins
- `admin/includes/header.php` - обновлено меню с учетом прав
- `admin/logout.php` - корректный редирект по типу админа
- `admin/orders.php` - фильтрация по location_id
- `admin/services.php` - доступ только для суперадмина
- `admin/admins.php` - доступ только для суперадмина
- `admin/settings.php` - доступ только для суперадмина
- `admin/logs.php` - доступ только для суперадмина

## Безопасность

### Рекомендации по безопасности:

1. **Измените все пароли по умолчанию** сразу после установки
2. **Используйте сложные пароли** для суперадмина и точек (минимум 12 символов)
3. **Регулярно проверяйте логи** доступа к системе
4. **Ограничьте доступ к файлу миграции** после установки:
   ```bash
   chmod 600 migrations/add_multi_location_support.sql
   ```
5. **Настройте HTTPS** для защиты данных при передаче

### Пароли по умолчанию:

- **Все точки:** `password`
- **Суперадмин:** см. Шаг 4 выше

⚠️ **ОБЯЗАТЕЛЬНО ИЗМЕНИТЕ ЭТИ ПАРОЛИ!**

## Устранение неполадок

### Проблема: "Неверная точка или пароль"

**Решение:**
1. Проверьте, что точка активна в таблице `locations` (`is_active = 1`)
2. Убедитесь, что код точки написан правильно (чувствителен к регистру)
3. Попробуйте сбросить пароль точки через суперадмина

### Проблема: "Доступ запрещен" при попытке открыть страницу

**Решение:**
1. Проверьте, что вы вошли под правильным типом администратора
2. Убедитесь, что сессия не истекла (перелогиньтесь)
3. Для location admin недоступны: услуги, администраторы, настройки, логи, чаты

### Проблема: Не видны заказы на странице заказов

**Решение:**
1. Убедитесь, что у заказов установлено поле `location_id`
2. Для location admin - проверьте, что `location_id` заказов совпадает с вашей точкой
3. Выполните SQL запрос для проверки:
   ```sql
   SELECT * FROM orders WHERE location_id = YOUR_LOCATION_ID;
   ```

### Проблема: Ошибка при миграции БД

**Решение:**
1. Убедитесь, что у вас есть права на создание таблиц и изменение структуры
2. Проверьте, не существуют ли уже таблицы/поля из миграции
3. Выполните миграцию по частям, если возникают ошибки

## Дополнительная информация

### API Endpoints для работы с точками:

- `GET /admin/api/locations.php?action=list` - список всех точек
- `GET /admin/api/locations.php?action=get&id=1` - получить точку по ID
- `POST /admin/api/locations.php?action=create` - создать точку
- `POST /admin/api/locations.php?action=update` - обновить точку
- `POST /admin/api/locations.php?action=toggle` - изменить статус
- `POST /admin/api/locations.php?action=delete` - удалить точку
- `GET /admin/api/locations.php?action=stats&id=1` - статистика точки

### Функции для проверки прав:

```php
// В любом месте admin панели:
isSuperAdmin()         // Проверка, является ли пользователь супер-админом
isLocationAdmin()       // Проверка, является ли пользователь админом точки
getCurrentLocationId()  // Получить ID текущей точки (для location admin)
```

## Контакты и поддержка

Если у вас возникли вопросы или проблемы, обратитесь к разработчику системы.
